{
  "asset": [
    {
      "groupKey": "primary",
      "item": {
        "created": 1552453805983,
        "createdBy": "google-oauth2|104792385606727687265",
        "id": "-L_pSHQhEyMTLKAOTXOy",
        "modified": 1552453805983,
        "modifiedBy": "google-oauth2|104792385606727687265",
        "parameter": {
          "general": {
            "county": "Pima County",
            "state": "AZ",
            "zip": "85629"
          },
          "location": {
            "lat": 31.86952819999999,
            "long": -111.12537250000003
          },
          "name": {
            "description": "Sierrita Mine East Pit, Arizona 85629, USA",
            "name": "Sierrita Mine Site Test",
            "type": "parameter:name:basic"
          },
          "notes": {
            "data": "2019-2-1 - Notes on the issue"
          }
        },
        "rn": "team/rmi-freeport/asset/-L_pSHQhEyMTLKAOTXOy",
        "tags": [
          "mining site",
          "land",
          "asset"
        ],
        "type": "asset:land:mine"
      },
      "itemKey": "project",
      "rn": "team/rmi-freeport/asset/-L_pSHQhEyMTLKAOTXOy",
      "stepKey": "primary",
      "type": "asset:land:mine"
    }
  ],
  "data": [
    {
      "groupKey": "demand",
      "item": {
        "body": {
          "stringify": true
        },
        "columns": [
          {
            "format": "DateTime",
            "name": "Date/Time",
            "prop": "DateTime"
          },
          {
            "format": "Float",
            "name": "Avg Hourly Load (kW)",
            "prop": "AvgHourlyLoad(kW)"
          }
        ],
        "created": 1552453806286,
        "createdBy": "google-oauth2|104792385606727687265",
        "id": "-L_pSHVW6_SX1woiKQOg",
        "modified": 1552453806286,
        "modifiedBy": "google-oauth2|104792385606727687265",
        "parameter": {
          "name": {
            "description": "",
            "name": "Sierrita Hourly AVG Load",
            "type": "parameter:name:basic"
          }
        },
        "rn": "team/rmi-freeport/dataItem/-L_pSHVW6_SX1woiKQOg",
        "tags": [
          8760,
          "timeseries",
          "data"
        ],
        "type": "data:timeseries:8760"
      },
      "itemKey": "project",
      "rn": "team/rmi-freeport/dataItem/-L_pSHVW6_SX1woiKQOg",
      "stepKey": "load",
      "type": "data:timeseries:8760"
    },
    {
      "groupKey": "tourate",
      "item": {
        "created": 1559849426754,
        "createdBy": "google-oauth2|104792385606727687265",
        "id": "-LgiGKTCmAdg0437mQfi",
        "modified": 1559849426754,
        "modifiedBy": "google-oauth2|104792385606727687265",
        "parameter": {
          "name": {
            "aoSets": [
              "parameter:name:basic"
            ],
            "description": "APPLICABILITY:\r\nService under this price plan is applicable to customers having a monthly maximum billing demand in excess of 1,000 kilowatts (kW), whose service is metered at the low side of a dedicated or customer-owned substation transformer(s), supplied through one point of delivery and measured through one or more meters as approved by SRP. Not available to other customers. Limited to customers whose usage can be measured by time of day.",
            "name": "E-65 STANDARD PRICE PLAN FOR SUBSTATION LARGE GENERAL SERVICE"
          }
        },
        "rn": "team/rmi-freeport/dataItem/-LgiGKTCmAdg0437mQfi",
        "tags": [
          "time of use rate",
          "object",
          "data"
        ],
        "type": "data:object:tourate"
      },
      "itemKey": "project",
      "rn": "team/rmi-freeport/dataItem/-LgiGKTCmAdg0437mQfi",
      "stepKey": "supply",
      "type": "data:object:tourate"
    }
  ],
  "overrides": [
    {
      "before": 10,
      "item": "project",
      "name": "Capacity",
      "prop": "step.solar.parameter.solar.capacityPower",
      "value": 10
    }
  ],
  "project": {
    "created": 1552454653383,
    "createdBy": "google-oauth2|104792385606727687265",
    "id": "-L_pVWISFc8q3-jgPM0z",
    "modified": 1559850756529,
    "modifiedBy": "google-oauth2|104792385606727687265",
    "parameter": {
      "name": {
        "name": "Sierrita Project"
      }
    },
    "rn": "team/rmi-freeport/project/-L_pVWISFc8q3-jgPM0z",
    "step": {
      "battery": {
        "key": "battery",
        "parameter": {
          "batterycapitalcost": {
            "aoSets": [
              "parameter:batterycapitalcost:default"
            ],
            "capacityCosts": 1350,
            "energyCosts": 1100,
            "type": "parameter:batterycapitalcost:default"
          },
          "batterycharacter": {
            "aoSets": [
              "parameter:batterycharacter:default"
            ],
            "chargeEfficiency": 0.95,
            "dischargeEfficiency": 0.95,
            "type": "parameter:batterycharacter:default"
          },
          "batterysize": {
            "aoSets": [
              "parameter:batterysize:default"
            ],
            "duration": 1,
            "power": 5,
            "type": "parameter:batterysize:default"
          }
        },
        "type": "project:siteanalysis:battery"
      },
      "financial": {
        "key": "financial",
        "parameter": {
          "simplefinance": {
            "aoSets": [
              "parameter:simplefinance:default"
            ],
            "discountRate": 0.08,
            "federalTaxRate": 0.25,
            "inflationRate": 0.03,
            "omEscalationRate": 0.02,
            "period": 25,
            "stateTaxRate": 0.05,
            "type": "parameter:simplefinance:default"
          }
        },
        "type": "project:siteanalysis:financial"
      },
      "gens": {
        "parameter": {
          "search": {
            "clat": 31.86952819999999,
            "clng": -111.12537250000003
          }
        }
      },
      "land": {
        "parameter": {
          "search": {
            "clat": 31.86952819999999,
            "clng": -111.12537250000003
          }
        }
      },
      "line": {
        "parameter": {
          "search": {
            "clat": 31.86952819999999,
            "clng": -111.12537250000003
          }
        }
      },
      "load": {
        "data": {
          "demand": {
            "team%2Frmi-freeport%2FdataItem%2F-L_pSHVW6_SX1woiKQOg": {
              "groupKey": "demand",
              "item": {
                "body": {
                  "stringify": true
                },
                "columns": [
                  {
                    "format": "DateTime",
                    "name": "Date/Time",
                    "prop": "DateTime"
                  },
                  {
                    "format": "Float",
                    "name": "Avg Hourly Load (kW)",
                    "prop": "AvgHourlyLoad(kW)"
                  }
                ],
                "created": 1552453806286,
                "createdBy": "google-oauth2|104792385606727687265",
                "id": "-L_pSHVW6_SX1woiKQOg",
                "modified": 1552453806286,
                "modifiedBy": "google-oauth2|104792385606727687265",
                "parameter": {
                  "name": {
                    "description": "",
                    "name": "Sierrita Hourly AVG Load",
                    "type": "parameter:name:basic"
                  }
                },
                "rn": "team/rmi-freeport/dataItem/-L_pSHVW6_SX1woiKQOg",
                "tags": [
                  8760,
                  "timeseries",
                  "data"
                ],
                "type": "data:timeseries:8760"
              },
              "itemKey": "project",
              "rn": "team/rmi-freeport/dataItem/-L_pSHVW6_SX1woiKQOg",
              "stepKey": "load",
              "type": "data:timeseries:8760"
            }
          }
        },
        "key": "load",
        "parameter": {
          "demand": {
            "absolutegrowth": 0,
            "absolutegrowth-units": "units:rate_energy|time:MWh|yr",
            "annualenergyscale": 0,
            "annualenergyscale-units": "units:energy:MWh",
            "aoSets": [
              "parameter:demand:growth"
            ],
            "peakdemandscale": 0,
            "peakdemandscale-units": "units:power:MW",
            "percentgrowth": 0,
            "percentgrowth-units": "units:rate_percent|time:%|yr",
            "type": "parameter:demand:growth"
          }
        },
        "type": "project:siteanalysis:load"
      },
      "primary": {
        "asset": {
          "primary": {
            "team%2Frmi-freeport%2Fasset%2F-L_pSHQhEyMTLKAOTXOy": {
              "groupKey": "primary",
              "item": {
                "created": 1552453805983,
                "createdBy": "google-oauth2|104792385606727687265",
                "id": "-L_pSHQhEyMTLKAOTXOy",
                "modified": 1552453805983,
                "modifiedBy": "google-oauth2|104792385606727687265",
                "parameter": {
                  "general": {
                    "county": "Pima County",
                    "state": "AZ",
                    "zip": "85629"
                  },
                  "location": {
                    "lat": 31.86952819999999,
                    "long": -111.12537250000003
                  },
                  "name": {
                    "description": "Sierrita Mine East Pit, Arizona 85629, USA",
                    "name": "Sierrita Mine Site Test",
                    "type": "parameter:name:basic"
                  },
                  "notes": {
                    "data": "2019-2-1 - Notes on the issue"
                  }
                },
                "rn": "team/rmi-freeport/asset/-L_pSHQhEyMTLKAOTXOy",
                "tags": [
                  "mining site",
                  "land",
                  "asset"
                ],
                "type": "asset:land:mine"
              },
              "itemKey": "project",
              "rn": "team/rmi-freeport/asset/-L_pSHQhEyMTLKAOTXOy",
              "stepKey": "primary",
              "type": "asset:land:mine"
            }
          }
        },
        "key": "primary",
        "type": "project:greenfield:primary"
      },
      "solar": {
        "key": "solar",
        "parameter": {
          "solar": {
            "aoSets": [
              "parameter:solar:default"
            ],
            "capacityCost": 1200,
            "capacityPower": 10,
            "capacityPower-units": "units:power:MW",
            "degradationRate": 0.003,
            "omCost": 5,
            "type": "parameter:solar:default"
          }
        },
        "type": "project:siteanalysis:solar"
      },
      "start": {
        "parameter": {
          "location": {
            "aoSets": [
              "parameter:location:latlng"
            ],
            "lat": 31.86952819999999,
            "long": -111.12537250000003
          },
          "name": {
            "aoSets": [
              "parameter:name:basic"
            ],
            "name": "Sierrita Project",
            "type": "parameter:name:basic"
          }
        }
      },
      "subs": {
        "parameter": {
          "search": {
            "clat": 31.86952819999999,
            "clng": -111.12537250000003
          }
        }
      },
      "supply": {
        "data": {
          "tourate": {
            "team%2Frmi-freeport%2FdataItem%2F-LgiGKTCmAdg0437mQfi": {
              "groupKey": "tourate",
              "item": {
                "created": 1559849426754,
                "createdBy": "google-oauth2|104792385606727687265",
                "id": "-LgiGKTCmAdg0437mQfi",
                "modified": 1559849426754,
                "modifiedBy": "google-oauth2|104792385606727687265",
                "parameter": {
                  "name": {
                    "aoSets": [
                      "parameter:name:basic"
                    ],
                    "description": "APPLICABILITY:\r\nService under this price plan is applicable to customers having a monthly maximum billing demand in excess of 1,000 kilowatts (kW), whose service is metered at the low side of a dedicated or customer-owned substation transformer(s), supplied through one point of delivery and measured through one or more meters as approved by SRP. Not available to other customers. Limited to customers whose usage can be measured by time of day.",
                    "name": "E-65 STANDARD PRICE PLAN FOR SUBSTATION LARGE GENERAL SERVICE"
                  }
                },
                "rn": "team/rmi-freeport/dataItem/-LgiGKTCmAdg0437mQfi",
                "tags": [
                  "time of use rate",
                  "object",
                  "data"
                ],
                "type": "data:object:tourate"
              },
              "itemKey": "project",
              "rn": "team/rmi-freeport/dataItem/-LgiGKTCmAdg0437mQfi",
              "stepKey": "supply",
              "type": "data:object:tourate"
            }
          }
        },
        "key": "supply",
        "type": "project:siteanalysis:supply"
      }
    },
    "tags": [
      "mining site",
      "project"
    ],
    "type": "project:mineanalysis"
  },
  "run": {
    "created": 1564430654174,
    "createdBy": "google-oauth2|104792385606727687265",
    "description": "Capacity=10",
    "groupId": "empty-baboon-303-A",
    "groupRef": {
      "rn": "team/rmi-freeport/scenarioRunGroupItem/-LkzKGCqFXbMyQ4Uo0o1"
    },
    "id": "-LkzKKIRo8h6dhe_OueV",
    "message": "Setting Scenario Context.",
    "modified": 1564430654174,
    "modifiedBy": "google-oauth2|104792385606727687265",
    "name": {
      "asset": [
        "Sierrita Mine Site Test"
      ],
      "project": "Sierrita Project",
      "run": "Sierrita Project/Solar, Battery, and Financials v3 [empty-baboon-303-A-1]",
      "runId": "empty-baboon-303-A-1",
      "scenario": "Solar, Battery, and Financials v3",
      "scenarioInput": "Solar Scan"
    },
    "overrides": [
      {
        "before": 10,
        "item": "project",
        "name": "Capacity",
        "prop": "step.solar.parameter.solar.capacityPower",
        "value": 10
      }
    ],
    "parameter": {
      "name": {
        "name": "Sierrita Project/Solar, Battery, and Financials v3 [empty-baboon-303-A-1]"
      }
    },
    "project": {
      "step": {
        "solar": {
          "parameter": {
            "solar": {
              "capacityPower": 10
            }
          }
        }
      },
      "type": "project:mineanalysis"
    },
    "resource": {
      "asset": [
        "team/rmi-freeport/asset/-L_pSHQhEyMTLKAOTXOy"
      ],
      "data": [
        "team/rmi-freeport/dataItem/-L_pSHVW6_SX1woiKQOg",
        "team/rmi-freeport/dataItem/-LgiGKTCmAdg0437mQfi"
      ],
      "project": "team/rmi-freeport/project/-L_pVWISFc8q3-jgPM0z",
      "run": "team/rmi-freeport/scenarioRunItem/-LkzKKIRo8h6dhe_OueV",
      "scenario": "team/rmi-freeport/scenarioItem/-Lg3zUO3acJ-H86UhJgT"
    },
    "rn": "team/rmi-freeport/scenarioRunItem/-LkzKKIRo8h6dhe_OueV",
    "scenario": {
      "type": "scenario:sampypsaexcel"
    },
    "status": "Creating",
    "step": {
      "financial": {
        "key": "financial",
        "message": "Waiting for dependencies to be met.",
        "parent": "power",
        "status": "Waiting",
        "task": {
          "rn": "team/rmi-freeport/task/-L_pSHj1zRNleX-0I9hC"
        },
        "type": "scenario:financial:excel"
      },
      "power": {
        "key": "power",
        "message": "Waiting for dependencies to be met.",
        "parent": "sam",
        "status": "Waiting",
        "task": {
          "rn": "team/rmi-freeport/task/-L_pSH_edSKeHvXUJZZ8"
        },
        "type": "scenario:power:pypsa"
      },
      "sam": {
        "key": "sam",
        "message": "Waiting for dependencies to be met.",
        "parent": "weather",
        "status": "Waiting",
        "task": {
          "rn": "team/rmi-freeport/task/-L_pSHVyM4QMx5Q_F4E3"
        },
        "type": "scenario:nrel:sam"
      },
      "weather": {
        "key": "weather",
        "message": "Waiting for dependencies to be met.",
        "status": "Waiting",
        "task": {
          "rn": "team/rmi-freeport/task/-L_pSHTYIis-8UV8Hpbb"
        },
        "type": "scenario:nrel:weather"
      }
    },
    "type": "run:scenario:sampypsaexcel"
  },
  "scenario": {
    "created": 1559156881015,
    "createdBy": "google-oauth2|104792385606727687265",
    "id": "-Lg3zUO3acJ-H86UhJgT",
    "modified": 1559158037115,
    "modifiedBy": "google-oauth2|104792385606727687265",
    "parameter": {
      "name": {
        "aoSets": [
          "parameter:name:basic"
        ],
        "description": "A description",
        "name": "Solar, Battery, and Financials v3",
        "type": "parameter:name:basic"
      }
    },
    "rn": "team/rmi-freeport/scenarioItem/-Lg3zUO3acJ-H86UhJgT",
    "step": {
      "financial": {
        "key": "financial",
        "parameter": {
          "exceltemplate": {
            "aoSets": [
              "parameter:exceltemplate:io"
            ],
            "filename": "template-v4.xlsx",
            "input": {
              "map": [
                {
                  "ao_note": true,
                  "cell": "C7",
                  "item": "project",
                  "prop": "step.solar.parameter.solar.capacityPower",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "A1",
                  "filename": "{scenario_folder}/pcm-monthly-{run_id}.csv",
                  "sheet": "AO Monthly",
                  "type": "csv"
                },
                {
                  "cell": "A1",
                  "filename": "{scenario_folder}/pcm-hourly-{run_id}.csv",
                  "sheet": "AO Hourly",
                  "type": "csv"
                },
                {
                  "cell": "C8",
                  "fixed": "Fixed Tilt",
                  "if": {
                    "prop": "step.sam.parameter.panelorientation.tracker",
                    "value": "1 Axis"
                  },
                  "item": "scenario",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C8",
                  "fixed": "1-Axis Tracker",
                  "if": {
                    "prop": "step.sam.parameter.panelorientation.tracker",
                    "value": "1 Axis"
                  },
                  "item": "scenario",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C16",
                  "item": "project",
                  "prop": "step.financial.parameter.simplefinance.inflationRate",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C17",
                  "item": "project",
                  "prop": "step.financial.parameter.simplefinance.discountRate",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C18",
                  "item": "project",
                  "prop": "step.financial.parameter.simplefinance.stateTaxRate",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C19",
                  "item": "project",
                  "prop": "step.financial.parameter.simplefinance.federalTaxRate",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C20",
                  "item": "project",
                  "prop": "step.financial.parameter.simplefinance.omEscalationRate",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C22",
                  "item": "project",
                  "prop": "step.solar.parameter.solar.capacityCost",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C23",
                  "item": "project",
                  "prop": "step.solar.parameter.solar.omCost",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C24",
                  "item": "scenarioRun",
                  "prop": "step.sam.output.kwh_per_kw",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C25",
                  "item": "project",
                  "prop": "step.solar.parameter.solar.degradationRate",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C27",
                  "item": "project",
                  "prop": "step.battery.parameter.batterysize.power",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C28",
                  "item": "project",
                  "prop": "step.battery.parameter.batterysize.duration",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C29",
                  "item": "project",
                  "prop": "step.battery.parameter.batterycharacter.chargeEfficiency",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C30",
                  "item": "project",
                  "prop": "step.battery.parameter.batterycharacter.dischargeEfficiency",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C31",
                  "item": "project",
                  "prop": "step.battery.parameter.batterycapitalcost.capacityCosts",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "C32",
                  "item": "project",
                  "prop": "step.battery.parameter.batterycapitalcost.energyCosts",
                  "sheet": "Scenario Parameters"
                },
                {
                  "cell": "B3",
                  "fixed": "AO Inputs",
                  "name": "Ao Inputs",
                  "sheet": "AO Overview",
                  "style": {
                    "bold": false,
                    "size": 17
                  }
                },
                {
                  "col": 2,
                  "fixed": "Primary Mine",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "style": {
                    "bold": true,
                    "size": 14
                  }
                },
                {
                  "col": 2,
                  "item": "primary",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "step_name": "Mine Asset",
                  "step_path": "."
                },
                {
                  "cell": "E5",
                  "fixed": "Project",
                  "pad_row": 4,
                  "sheet": "AO Overview",
                  "style": {
                    "bold": true,
                    "size": 14
                  }
                },
                {
                  "col": 5,
                  "item": "project",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "step_name": "Primary Asset",
                  "step_path": "step.primary"
                },
                {
                  "col": 5,
                  "item": "project",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "step_name": "Onsite Load",
                  "step_path": "step.load"
                },
                {
                  "col": 5,
                  "item": "project",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "step_name": "Supply",
                  "step_path": "step.supply"
                },
                {
                  "col": 5,
                  "item": "project",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "step_name": "Solar",
                  "step_path": "step.solar"
                },
                {
                  "col": 5,
                  "item": "project",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "step_name": "Battery",
                  "step_path": "step.battery"
                },
                {
                  "col": 5,
                  "item": "project",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "step_name": "Financial",
                  "step_path": "step.financial"
                },
                {
                  "cell": "H5",
                  "fixed": "Scenario",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "style": {
                    "bold": true,
                    "size": 14
                  }
                },
                {
                  "col": 8,
                  "item": "scenario",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "step_name": "NREL Sam",
                  "step_path": "step.sam"
                },
                {
                  "col": 8,
                  "item": "scenario",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "step_name": "NSRDB Weather",
                  "step_path": "step.weather"
                },
                {
                  "col": 8,
                  "ignore": true,
                  "item": "scenario",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "step_name": "AO Pypsa",
                  "step_path": "step.power"
                },
                {
                  "col": 8,
                  "ignore": true,
                  "item": "scenario",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "step_name": "Excel Cashflow",
                  "step_path": "step.financial"
                },
                {
                  "cell": "K3",
                  "fixed": "AO Output",
                  "sheet": "AO Overview",
                  "style": {
                    "bold": true,
                    "size": 17
                  }
                },
                {
                  "col": 11,
                  "fixed": "Scenario Run",
                  "pad_row": 2,
                  "sheet": "AO Overview",
                  "style": {
                    "bold": true,
                    "size": 14
                  }
                },
                {
                  "col": 11,
                  "group_name": "NREL Sam",
                  "item": "scenarioRun",
                  "pad_row": 2,
                  "prop": "name.runId",
                  "sheet": "AO Overview"
                },
                {
                  "col": 11,
                  "group_name": "NREL Sam",
                  "item": "scenarioRun",
                  "pad_row": 2,
                  "prop": "groupRef.rn",
                  "sheet": "AO Overview"
                },
                {
                  "col": 11,
                  "group_name": "NREL Sam",
                  "item": "scenarioRun",
                  "pad_row": 2,
                  "parameter_group": "step.sam.output",
                  "sheet": "AO Overview"
                },
                {
                  "col": 11,
                  "group_name": "Power",
                  "item": "scenarioRun",
                  "pad_row": 2,
                  "parameter_group": "step.power.output",
                  "sheet": "AO Overview"
                },
                {
                  "col": 11,
                  "group_name": "NSRDB Weather",
                  "item": "scenarioRun",
                  "pad_row": 2,
                  "parameter_group": "step.weather.output",
                  "sheet": "AO Overview"
                }
              ]
            },
            "output": {
              "map": [
                {
                  "cell": "G9",
                  "item": "scenarioRun",
                  "name": "npv",
                  "prop": "step.financial.output.npv",
                  "sheet": "Calculations"
                },
                {
                  "cell": "G12",
                  "item": "scenarioRun",
                  "name": "irr",
                  "prop": "step.financial.output.irr",
                  "sheet": "Calculations"
                },
                {
                  "cell": "G13",
                  "item": "scenarioRun",
                  "name": "simple_payback",
                  "prop": "step.financial.output.simple_payback",
                  "sheet": "Calculations"
                },
                {
                  "cell": "G14",
                  "item": "scenarioRun",
                  "name": "carbon_savings_total",
                  "prop": "step.financial.output.carbon_savings_total",
                  "sheet": "Calculations"
                },
                {
                  "cell": "G16",
                  "item": "scenarioRun",
                  "name": "direct_footprint",
                  "prop": "step.financial.output.direct_footprint",
                  "sheet": "Calculations"
                },
                {
                  "cell": "G18",
                  "item": "scenarioRun",
                  "name": "mean_dscr",
                  "prop": "step.financial.output.mean_dscr",
                  "sheet": "Calculations"
                },
                {
                  "cell": "G19",
                  "item": "scenarioRun",
                  "name": "years_of_low_dscr",
                  "prop": "step.financial.output.years_of_low_dscr",
                  "sheet": "Calculations"
                },
                {
                  "cell": "G20",
                  "item": "scenarioRun",
                  "name": "min_dscr",
                  "prop": "step.financial.output.min_dscr",
                  "sheet": "Calculations"
                },
                {
                  "columns": [
                    {
                      "col": "C",
                      "name": "name"
                    },
                    {
                      "col": "D",
                      "name": "value"
                    }
                  ],
                  "data": "keyvalue",
                  "item": "scenarioRun",
                  "name": "waterfall",
                  "rows": [
                    172,
                    179
                  ],
                  "sheet": "Calculations"
                },
                {
                  "file": "csv",
                  "hcolumns": [
                    2,
                    28
                  ],
                  "hrows": [
                    {
                      "name": "year",
                      "row": 43
                    },
                    {
                      "name": "solar_value",
                      "row": 55
                    },
                    {
                      "name": "dscr",
                      "row": 74
                    },
                    {
                      "name": "tei_cashflow",
                      "row": 98
                    },
                    {
                      "name": "annual_cashflow",
                      "row": 102
                    },
                    {
                      "name": "cummulative_benefit",
                      "row": 103
                    }
                  ],
                  "item": "scenarioRun",
                  "name": "Annual Details",
                  "sheet": "Calculations"
                }
              ]
            },
            "type": "parameter:exceltemplate:io"
          }
        },
        "task": {
          "rn": "team/rmi-freeport/task/-L_pSHj1zRNleX-0I9hC"
        },
        "type": "scenario:financial:excel"
      },
      "power": {
        "key": "power",
        "task": {
          "rn": "team/rmi-freeport/task/-L_pSH_edSKeHvXUJZZ8"
        },
        "type": "scenario:power:pypsa"
      },
      "sam": {
        "key": "sam",
        "parameter": {
          "panelorientation": {
            "aoSets": [
              "parameter:panelorientation:standard"
            ],
            "tilt_eq_lat": true,
            "tracker": "1 Axis",
            "type": "parameter:panelorientation:standard"
          },
          "systemdesign": {
            "aoSets": [
              "parameter:systemdesign:implicit"
            ],
            "dctoacratio": 1.2,
            "inverters": 5,
            "modulesperstring": 5,
            "stringsinparallel": 5,
            "type": "parameter:systemdesign:implicit"
          }
        },
        "task": {
          "rn": "team/rmi-freeport/task/-L_pSHVyM4QMx5Q_F4E3"
        },
        "type": "scenario:nrel:sam"
      },
      "weather": {
        "key": "weather",
        "parameter": {
          "nsrdbweather": {
            "aoSets": [
              "parameter:nsrdbweather:latlng"
            ],
            "interval": "60",
            "type": "parameter:nsrdbweather:latlng",
            "weathertype": "PSM",
            "weatheryear": "tmy"
          }
        },
        "task": {
          "rn": "team/rmi-freeport/task/-L_pSHTYIis-8UV8Hpbb"
        },
        "type": "scenario:nrel:weather"
      }
    },
    "tags": [
      "nrel sam",
      "xlsx",
      "pypsa"
    ],
    "type": "scenario:sampypsaexcel"
  },
  "scenarioInput": {
    "count": 4,
    "created": 1552453805989,
    "createdBy": "google-oauth2|104792385606727687265",
    "id": "-L_pSHT3dMM46JXTx97K",
    "modified": 1559158785062,
    "modifiedBy": "google-oauth2|104792385606727687265",
    "parameter": {
      "name": {
        "name": "Solar Scan",
        "type": "parameter:name:basic"
      }
    },
    "projectType": "project:mineanalysis",
    "rn": "team/rmi-freeport/scenarioInputItem/-L_pSHT3dMM46JXTx97K",
    "scenarioType": "scenario:sampypsaexcel",
    "sensitivity": [
      {
        "baseType": "project",
        "datatype": "Float",
        "floatDefineType": "linspace",
        "name": "Capacity",
        "numsample": 4,
        "prop": "step.solar.parameter.solar.capacityPower",
        "start": 5,
        "stop": 20,
        "values": [
          5,
          10,
          15,
          20
        ]
      }
    ],
    "tags": [
      "scenario-input"
    ],
    "type": "scenario-input"
  },
  "task": [
    {
      "item": {
        "created": 1552453807178,
        "createdBy": "google-oauth2|104792385606727687265",
        "id": "-L_pSHj1zRNleX-0I9hC",
        "modified": 1561519917312,
        "modifiedBy": "google-oauth2|104792385606727687265",
        "parameter": {
          "event": {
            "aoSets": [
              "parameter:event:basic"
            ],
            "data": {
              "key": "test "
            },
            "type": "parameter:event:basic"
          },
          "file": {
            "aoSets": [
              "parameter:file:python"
            ],
            "data": "import subprocess\nfrom shutil import copyfile\nfrom openpyxl import load_workbook\nfrom openpyxl.utils import coordinate_from_string, column_index_from_string, get_column_letter\nfrom xlsx_calc import get_file_item,get_path,set_path\nfrom openpyxl.styles import Font, Fill\n\nimport sys\nimport os\nimport json\nimport csv\nimport pprint\n\n\nprint(\"FetchWeather\")\nprint(\"Arguments %s\",sys.argv[:-2])\nscenario_run=sys.argv[1]\nscenario_info=sys.argv[2]\nprint \"scenario run\",scenario_run\n\nitems={\n    \"scenarioRun\":json.loads(scenario_info)\n}\n\nrun_id=items['scenarioRun']['name']['runId']\n\noutput_team=\"rmi-test-beta-system\"\n\nenv_info={\n    \"run_id\": run_id,\n    \"scenario_run\": scenario_run\n}\n\nif scenario_run:\n    scenario_folder='/'.join(['s_run',scenario_run])\n    context_file='/'.join([scenario_folder,'context.json'])\n    env_info['scenario_folder']=scenario_folder\n    with open(context_file) as infile:\n        data = json.load(infile)\n    \tprimaries=[itemRef['item'] for itemRef in data['asset'] if itemRef['groupKey']=='primary']\n    \tprimary=primaries[0]\n        items['scenario']=data['scenario']\n        items['project']=data['project']\n        items['primary']=primary\n        input_template=get_path(data['scenario'],'step.financial.parameter.exceltemplate.input')\n        output_template=get_path(data['scenario'],'step.financial.parameter.exceltemplate.output')\n        template_file=get_path(data['scenario'],'step.financial.parameter.exceltemplate.filename')\n        if 'file' not in data:\n            data['file']=[]\n        ## Does not account for multiple file overrides\n        items['files']={fileRef['groupKey']:fileRef for fileRef in data['file']}\n        items['files']={}\n        for step in items['project']['step']:\n            if 'file' in items['project']['step'][step]:\n                files=items['project']['step'][step]['file']\n                for file_group in files:\n                    for file_id in files[file_group]:\n                        items['files'][file_group]=files[file_group][file_id]\n            \n        #desired_capacity=get_path(data,'scenario.step.sam.parameter.systemdesign.capacity')*1000\n        print \"\"\n        print \"templates\"\n        print 'input',input_template\n        print \"\"\n        print 'output',output_template\n        print \"\"\n        print \"files\",items['files']\nelse:\n    desired_capacity=50\n    scenario_run=\"test3\"\n    scenario_folder=\"s_run/\"+scenario_run\n    template_file='/var/task/finance-with-ao-waterfall.xlsx'\n    input_template={\n        \"map\":[\n            {\n                \"cell\":\"B37\",\n                \"group_name\":\"parameters\",\n                \"parameter_group\":\"step.financial\",\n                \"sheet\":\"Cover\"\n            }    \n        ]\n    }\n    output_template={\n        \"map\":[\n            {\n                \"item\": \"scenarioRun\",\n                \"name\": \"waterfall\",\n                \"sheet\": \"Scenario 3\",\n                \"rows\": [144,151],\n                \"columns\": [\n                    {\n                        \"name\": \"name\",\n                        \"col\": \"C\"\n                    },\n                    {\n                        \"name\": \"value\",\n                        \"col\": \"D\"\n                    }\n                ],\n                \"data\": \"keyvalue\"}\n            ]\n    }\n\nfilename=\"financial-{rid}.xlsx\".format(rid=run_id)\nmodified_file=\"/tmp/{fn}\".format(fn=filename)\ncalc_folder='/tmp/calc'\ncalc_file='/tmp/calc/{fn}'.format(fn=filename)\noutput_file='{sf}/output.xlsx'.format(sf=scenario_folder)\n\n# Make Paths\npaths=['tmp','tmp/calc']\n# https://stackoverflow.com/questions/273192/how-can-i-create-a-directory-if-it-does-not-exist/14364249#14364249\nfor path in paths:\n\ttry: \n\t    dir_path=scenario_folder+'/'+path\n\t    print 'MakeDirs',dir_path\n\t    os.makedirs(dir_path)\n\texcept OSError as e:\n\t    print \"Except error\",e\n#\t    if not os.path.isdir(path):\n#\t        raise\n\n\n## Change Parameters\nwb = load_workbook(filename = template_file)\n\ndef get_col_row(cell):\n    xy = coordinate_from_string(cell) # returns ('A',4)\n    col = column_index_from_string(xy[0]) # returns 1\n    row = xy[1]\n    return col,row\n\ndef write_parameter_group(start_cell,name,parameters):\n    print 'Write parameter groups',start_cell,name,parameters\n    start_cell.value=name\n    start_cell.font = Font(bold=True)\n    row=0\n    for i in parameters:\n        if i=='type':\n            continue\n        if i=='aoSets':\n            continue\n        row+=1\n        val = parameters[i]\n        label_cell=start_cell.offset(row,0)\n        value_cell=start_cell.offset(row,1)\n        print \"Setting\",i,val,name\n        label_cell.value=i\n        value_cell.value=val\n        if isinstance(val,float):\n            value_cell.number_format = '0.00'\n    return row\n\ndef write_step(start_cell,name,step):\n    print \"WriteStep\",name,step\n    start_cell.value=name\n    start_cell.font = Font(bold=True,underline=\"single\",size=13)\n    row=0\n    if 'parameter' not in step:\n        return row\n    for p in step['parameter']:\n        row+=1\n        params=step['parameter'][p]\n        print \"params\",row,p,params\n        cell=start_cell.offset(row,0)\n        rows_consumed=write_parameter_group(cell,p,params)\n        row+=rows_consumed\n    return row\n\ni_map=input_template['map']\ncurrent_row=None\nfor i in i_map:\n    print \"InputMap\",i\n    if 'ignore' in i:\n        continue\n    if i['sheet'] not in wb.sheetnames:\n        wb.create_sheet(i['sheet'])\n    sheet= wb[i['sheet']]\n    cell=None\n    if 'cell' in i:\n        col,row=get_col_row(i['cell'])\n        print \"Start at \",col,row\n        cell=sheet.cell(row,col)\n    elif 'col' in i and current_row:\n        if 'pad_row' in i:\n            current_row += i['pad_row']\n        cell=sheet.cell(current_row,i['col'])\n    if not cell:\n        print 'No starting cell'\n        continue\n    \n    font=None\n    if 'style' in i:\n        print 'HaveStyle',i['style']\n        font=Font(**i['style'])\n    \n    # Have starting cell\n    print 'Start Cell:',cell.col_idx,cell.column,cell.coordinate,cell.row\n    item = None\n    if 'item' in i:\n        item=items[i['item']]\n    elif 'fixed' in i:\n        value=i['fixed']\n        print 'Value',value\n        cell.value=value\n        if font:\n            cell.font = font\n        current_row=cell.row\n        continue\n    elif 'filename' in i and 'type' in i:\n        fn_raw=i['filename']\n        print('EnvInfo',env_info)\n        fn=fn_raw.format(**env_info)\n        print 'Filename',fn\n        if i['type']!='csv':\n            print \"Can only handle CSV!\"\n            continue\n        with open('./'+fn) as f:\n            reader = csv.reader(f)\n            for row in reader:\n                sheet.append(row)\n        continue\n    elif 'filegroup' in i and 'type' in i:\n        fg = i['filegroup']\n        if fg not in items['files']:\n            continue\n        fn_raw=items['files'][fg]['rn']\n        print 'fnraw',fn_raw\n        print('EnvInfo',env_info)\n        fn=fn_raw.format(**env_info)\n        print 'Filename',fn\n        if i['type']!='csv':\n            print \"Can only handle CSV!\"\n            continue\n        \n        start_col,start_row=get_col_row(i['cell'])\n        print 'start',start_col,start_row\n        with open('./'+fn) as f:\n            reader = csv.reader(f)\n            for row_index,row in enumerate(reader):\n                for col_index,col in enumerate(row):\n                    cell=sheet.cell(start_row+row_index,start_col+col_index)\n                    cell.value=col\n        continue\n    else:\n        continue\n    \n    # Have item, check for conditional\n    item=items[i['item']]\n    if 'if' in i:\n        value=get_path(item,i['if']['prop'])\n        if value != i['if']['value']:\n            continue\n    \n    # Write\n    if 'prop' in i:\n        item=items[i['item']]\n        print 'Prop value: ',i['item'],i['prop']\n        value=get_path(item,i['prop'])\n        print 'Value',value\n        cell.value=value\n        current_row=cell.row\n    elif 'fixed' in i:\n        cell.value=i['fixed']\n        current_row=cell.row\n    elif 'parameter_group' in i and 'group_name' in i:\n        print \"Write Parameter group\"\n        parameters=get_path(item,i['parameter_group'])\n        if parameters:\n            rows_consumed=write_parameter_group(cell,i['group_name'],parameters)\n            current_row=cell.row+rows_consumed\n            print 'CurrentRow',current_row\n    elif 'step_path' in i and 'step_name' in i:\n        print \"Write Step\"\n        step=None\n        if i['step_path']=='.':\n            step = item\n        else:\n            step=get_path(item,i['step_path'])\n        if step:\n            rows_consumed=write_step(cell,i['step_name'],step)\n            current_row=cell.row+rows_consumed\n            print 'CurrentRow',current_row\n\n\nwb.save(filename=modified_file)\n\ndef list_files(startpath):\n    for root, dirs, files in os.walk(startpath):\n        level = root.replace(startpath, '').count(os.sep)\n        indent = ' ' * 4 * (level)\n        print('{}{}/'.format(indent, os.path.basename(root)))\n        subindent = ' ' * 4 * (level + 1)\n        for f in files:\n            print('{}{}'.format(subindent, f))\nlist_files(scenario_folder)\n\n## Run Model\n#\ncommand=\"libreoffice --headless --invisible --nodefault --nofirststartwizard --nolockcheck --nologo --norestore --convert-to xlsx --outdir {calc_folder}\".format(calc_folder=calc_folder).split(' ')\ncommand = command + [modified_file]\nprint \"Run Libreoffice:\",command\nsubprocess.call(command)\n\n## Get Ouptut\nprint(os.getcwd())\nwb_out = load_workbook(filename =calc_file,data_only=True)\n\nresults = wb_out['Results']\n\nprint('Results:',results['D5'].value)\n\ncopyfile(calc_file, output_file)\n\nitemid=\"financial-{rid}-xlsx\".format(rid=run_id)\nname=\"Financials [{rid}].xlsx\".format(rid=run_id)\nao_item = get_file_item(output_file,itemid,name,filename)\nfile_output={\n\t\"path\":output_file,\n\t\"item\":ao_item,\n\t\"tid\":output_team,\n\t\"overwrite\":False\t\n}\n\ndef readRowsAndCols(sheet,rows,cols):\n    out=[]\n    start=rows[0]\n    end=rows[1]+1\n    for i in range(start,end):\n        r={}\n        for j in cols:\n            name=j['name']\n            col=j['col']\n            value=sheet[col+str(i)].value\n            r[name]=value\n        if 'key' not in r and 'name' in r and r['name']:\n            r['key']=r['name'].replace(' ','_').lower()\n        else:\n            print 'No key for output'\n            r['key']='unknown'\n            #unknown_count=unknown_count+1\n            #r['key']='unknown_key_'+str(unknown_count)\n        out.append(r)\n    return out\n\ndef readHRows(sheet,rows,cols):\n    out=[]\n    for r in rows:\n        name=r['name']\n        row=r['row']\n        start=cols[0]\n        end=cols[1]+1\n        values=[]\n        for c in range(start,end):\n            col_letter = get_column_letter(c)\n            cell=col_letter+str(row)\n            value=sheet[cell].value\n            r[name]=value\n            values.append(value)\n        info={\n            \"name\": name,\n            \"data\": values\n        }\n        out.append(info)\n    return out\n\n\ndef get_data_item(name,did):\n    obj={\n        \"id\":did,\n    \t\"type\": \"data:keyvalue\",\n    \t\"tags\":[\n    \t\t\"data\",\n    \t\t\"keyvalue\"\n    \t],\n    \t\"parameter\":{\n    \t\t\"name\": {\n    \t\t\t\"name\": name\n    \t\t}\n    \t},\n    \t\"columns\":[\n    \t\t{\n    \t\t\"format\": \"String\",\n    \t\t\"name\": \"Key\",\n    \t\t\"prop\": \"key\"\n    \t\t},{\n    \t\t\"format\": \"String\",\n    \t\t\"name\": \"Name\",\n    \t\t\"prop\": \"name\"\n    \t\t},{\n    \t\t\"format\": \"Float\",\n    \t\t\"name\": \"Value\",\n    \t\t\"prop\": \"value\"\n    \t\t}\n    \t]\n    }\n    return obj\n    \ndataitemname=\"Financial Waterfall [{rid}]\".format(rid=run_id)\ndataitemid=\"financial-waterfall-{rid}-json\".format(rid=run_id)\ndata_upload_file=scenario_folder+'/financial-waterfall-{rid}.json'.format(rid=run_id)\n\nannual_file_name=\"Annual Summary [{rid}].csv\".format(rid=run_id)\nannual_file_itemid=\"annual-summary-{rid}-csv\".format(rid=run_id)\nannual_file_path=scenario_folder+'/annual-summary-{rid}.csv'.format(rid=run_id)\nannual_filename='annual-summary-{rid}.csv'.format(rid=run_id)\n\nannual_data_item={\n  \"body\": {\n        \"file\": \"team/{tid}/file/{fid}\".format(tid=output_team,fid='ao_'+annual_file_itemid)\n  },\n  \"columns\": [\n    {\n      \"name\": \"Year\",\n      \"prop\": \"YearNumber\",\n      \"timeIndex\": True\n    },\n    {\n      \"name\": \"Total Solar Value\",\n      \"prop\": \"TotalSolarValue\"\n    },\n    {\n      \"name\": \"DSCR\",\n      \"prop\": \"DSCR\"\n    },\n    {\n      \"name\": \"TEI Cashflow\",\n      \"prop\": \"TEICashflow\"\n    },\n    {\n      \"name\": \"Annual Cashflow\",\n      \"prop\": \"AnnualCashflow\"\n    },\n    {\n      \"name\": \"Cumulative Benefit Against Cost\",\n      \"prop\": \"CumulativeBenefitAgainstCost\"\n    }\n  ],\n  \"parameter\": {\n    \"name\": {\n      \"name\": \"Annual Summary [{rid}]\".format(rid=run_id),\n      \"type\": \"parameter:name:basic\"\n    }\n  },\n  \"tags\": [\n    \"timeseries\",\n    \"data\"\n  ],\n  \"type\": \"data:timeseries\"\n}\n\nout_data={}\no_map=output_template['map']\nfor i in o_map:\n    #print \"OutputMap\",i\n    if i['sheet'] not in wb_out.sheetnames:\n        print 'Sheet does not exist, ignore'\n        continue\n    sheet= wb_out[i['sheet']]\n    if 'cell' in i:\n        value=sheet[i['cell']].value\n    elif 'rows' in i and 'columns' in i:\n        value=readRowsAndCols(sheet,i['rows'],i['columns'])\n        #print \"ROWS\",value\n    elif 'hrows' in i and 'hcolumns' in i:\n        value=readHRows(sheet,i['hrows'],i['hcolumns'])\n        #print \"HROWS\",value\n    #print 'Value',value\n    item=items[i['item']]\n    print 'Set',i['item'],i['name'],':',value\n    if 'data' in i:\n        ## create data object\n        print \"Data\",value\n        with open(data_upload_file,'w') as outfile:\n        \tjson.dump(value,outfile)\n        waterfall_data={\n            \"body\":data_upload_file,\n            \"item\":get_data_item(dataitemname,dataitemid),\n\t        \"tid\":output_team,\n            \"overwrite\":True\n        }\n    elif 'file' in i:\n        ## create file object\n        print \"File\", value\n        data=[d['data'] for d in value]\n        row_format=zip(*data)\n        \n        with open(annual_file_path, 'w') as csvfile:\n            csvwriter = csv.writer(csvfile, delimiter=',',quotechar='\"', quoting=csv.QUOTE_MINIMAL)\n            for r in row_format:\n                csvwriter.writerow(r)\n    else:\n        set_path(out_data,i['name'],value)\n\n\nao_annual_file_item = get_file_item(annual_file_path,annual_file_itemid,annual_file_name,annual_filename)\nao_file_output={\n\t\"path\":annual_file_path,\n\t\"item\":ao_annual_file_item,\n\t\"tid\":output_team,\n\t\"overwrite\":False\t\n}\nannual_data = {\n    \"item\": annual_data_item,\n    \"tid\": output_team\n}\n\noutput = {\n\t\"data\": out_data,\n\t\"output\": \"Test\",\n\t\"dataitem\":[\n\t    waterfall_data,\n\t    annual_data\n\t],\n\t\"file\":[\n\t\tfile_output,\n\t\tao_file_output\n\t]\n}\nstring = json.dumps(output)\nsys.stdout.flush()\nprint string\n",
            "name": "task-run-excel.py",
            "type": "parameter:file:python"
          },
          "name": {
            "aoSets": [
              "parameter:name:basic"
            ],
            "description": "Add support for forwards",
            "name": "Excel Cash Flow Analysis v4",
            "type": "parameter:name:basic"
          },
          "runtime": {
            "aoSets": [
              "parameter:runtime:basic"
            ],
            "args": "task-run-excel.py $scenarioRun",
            "entry": "python",
            "image": "andersonopt/task-openpyxl",
            "type": "parameter:runtime:basic"
          },
          "taskselector": {
            "aoSets": [
              "parameter:taskselector:basic"
            ],
            "queue": "task-dev",
            "type": "parameter:taskselector:basic",
            "typefilter": "scenario:financial:excel"
          },
          "workspace": {
            "aoSets": [
              "parameter:workspace:basic"
            ],
            "type": "parameter:workspace:basic",
            "workspace": "kickass_blackwell"
          }
        },
        "queue": "dev:task-compute",
        "rn": "team/rmi-freeport/task/-L_pSHj1zRNleX-0I9hC",
        "tags": [
          "docker",
          "task"
        ],
        "type": "task:docker",
        "version": 1
      },
      "itemKey": "scenario",
      "rn": "team/rmi-freeport/task/-L_pSHj1zRNleX-0I9hC",
      "stepKey": "financial"
    },
    {
      "item": {
        "created": 1552453806470,
        "createdBy": "google-oauth2|104792385606727687265",
        "id": "-L_pSH_edSKeHvXUJZZ8",
        "modified": 1561519906412,
        "modifiedBy": "google-oauth2|104792385606727687265",
        "parameter": {
          "event": {
            "aoSets": [
              "parameter:event:basic"
            ],
            "data": {
              "key": "test"
            },
            "type": "parameter:event:basic"
          },
          "file": {
            "aoSets": [
              "parameter:file:python"
            ],
            "data": "import pandas as pd\nimport itertools\nimport sys\nimport json\nimport os\n\nfrom powopt import TouRate,create_time_map,run_pcm,get_path\nfrom powopt import Output, DataOutput, FileOutput\nprint \"Running AO Pypsa\"\n\n#scenarioRun=os.environ['scenarioRun']\nif 'scenarioRun' in os.environ:\n    scenario_run=os.environ['scenarioRun']\nelse:\n    scenario_run=\"-LLHyhX9As1TDCOv4cGF\"\nprint \"Scenario run:\",scenario_run\n\noutput_team=\"rmi-test-beta-system\"\n\nscenario_run_item=json.loads(sys.argv[2])\nrun_id=scenario_run_item['name']['runId']\nprint \"scenario run item\",run_id,scenario_run_item\n\nload_file=None\ntou_file=None\nif scenario_run:\n    scenario_folder='/'.join(['s_run',scenario_run])\n    context_file='/'.join([scenario_folder,'context.json'])\n    with open(context_file) as infile:\n        data = json.load(infile)\n        try:\n            p_nom=float(get_path(data,'project.step.battery.parameter.batterysize.power'))\n            duration=float(get_path(data,'project.step.battery.parameter.batterysize.duration'))\n            charge_eff=float(get_path(data,'project.step.battery.parameter.batterycharacter.chargeEfficiency'))\n            discharge_eff=float(get_path(data,'project.step.battery.parameter.batterycharacter.dischargeEfficiency'))\n            data_files=get_path(scenario_run_item,'resource.data')\n            print 'DataFiles: ',data_files\n            load_files=[itemRef['rn'] for itemRef in data['data'] if itemRef['groupKey']=='demand']\n            tou_files=[itemRef['rn'] for itemRef in data['data'] if itemRef['groupKey']=='tourate']\n            print 'Load Files:',load_files\n            print 'TOU Files:',tou_files\n            f_load_id = load_files[0].split('/')[-1]\n            f_tou_id = tou_files[0].split('/')[-1]\n            load_file='dataItem/{file}.json'.format(file=f_load_id)\n            tou_file='dataItem/{file}.json'.format(file=f_tou_id)\n    \n        except Exception as e:\n            print \"ERROR Loading scenario values for battery size\"\n            print \"Error:\",e\n            p_nom=5\n            duration=1\n            #load_file='sierrita_load.json'\n            #tou_file='sierrita_tou.json'\nelse:\n    p_nom=5\n    duration=1\n###  Load and Time Map ######\n\n\nprint \"demand file\",load_file\ndata = pd.read_json(load_file)\ndt_index=data['DateTime']\ndf_time=create_time_map(dt_index)\nprint data.columns\ntry:\n    df_time['Load']=data['AvgHourlyLoad(kW)']\nexcept:\n    df_time['Load']=data['AverageLoad(kW)']\ndata=df_time\ndata['load']=data['Load']/1000\n\n\n\n#### Tou Rates\nprint \"Load TOU Rates\",tou_file\nwith open(tou_file) as infile:\n\ttourate = json.load(infile)\n\ntou = TouRate()\ntou.load_open_ei_data(tourate)\n\ndef get_period(row):\n\tif row['dt_WEEKDAY']:\n\t\treturn tou.demand.get_weekday_period(row['dt_M']-1,row['dt_H'])\n\telse:\n\t\treturn tou.demand.get_weekend_period(row['dt_M']-1,row['dt_H'])\n\n\ndef get_rate(row):\n\tif row['dt_WEEKDAY']:\n\t\treturn tou.energy.get_weekday_rate(row['dt_M']-1,row['dt_H'])*1000\n\telse:\n\t\treturn tou.energy.get_weekend_rate(row['dt_M']-1,row['dt_H'])*1000\n\ndata['total_rate']=data.apply(get_rate,axis=1)\ndata['demand_period']=data.apply(get_period,axis=1)\n\n\n\n## Buy / Sell\n\ngens = [\n\t{\n\t\t\"name\":\"buy\",\n\t\t\"p_nom\":1000,\n\t\t\"marginal_costs\":data['total_rate']\n\t}\n]\n\n### Solar Gen\n\n\ndef prep_solar_data(data,solar_file):\n\tsolar=pd.read_json(solar_file)\n\tmin_solar=-solar.min()['gen']\n\tdata['solar_load']=min_solar/1000\n\tsolar_gen=(solar['gen']+min_solar)\n\tsolar_p_nom_kw=solar_gen.max()\n\tdata['solar_gen']=solar_gen/solar_p_nom_kw\n\tkwh_kw= solar.sum()/solar_p_nom_kw\n\treturn solar_p_nom_kw/1000\n\n#\tprint 'Solar Yield (kwh/kw):',kwh_kw\n\n#data=data.head(240)\n\ninfo={}\n\t\n## Solar\n\n## Inputs\n\n#solar_p_nom_kw=size*1000\n#solar_file=\"data/{}_{}.json\".format(track,size)\nsolar_file=\"s_run/{sr}/nrel-sam-gen-{rid}.json\".format(sr=scenario_run,rid=run_id)\n\n#info['solar_tracking']=track\n#info['solar_size']=size\ninfo['solar_file']=solar_file\n\nsolar_p_nom=prep_solar_data(data,solar_file)\nsolar= [{\n\t\"name\": \"solar\",\n\t\"p_nom\": solar_p_nom,\n\t\"p_max_pu\": data['solar_gen'],\n\t\"marginal_costs\": 0\n}]\n\n## Battery\n\n\nstorage=[{\n\t\"name\":\"storage\",\n\t\"p_nom\":p_nom,\n\t\"max_hours\":duration,\n\t\"efficiency_store\":charge_eff,\n\t\"efficiency_dispatch\":discharge_eff\n}]\n\ninfo['battery_nom']=p_nom\ninfo['battery_duration']=duration\n\nresults=run_pcm(data,tou,gens,solar,storage)\n\nmonthly= results.get('month')\nhourly=results.get('hour')\nmonth_period=results.get('month_period')\n\nprint('Hourly Keys',hourly.columns)\n\nenergy_nom=p_nom*duration\nif energy_nom==0:\n    energy_nom=1\nhourly['movement']=hourly['dispatch'].abs()/energy_nom\nhourly['cycles']=hourly['movement'].cumsum()/2\n    \nmonthly['solar']=hourly.groupby('month').sum()['solar']\nmonthly['load']=hourly.groupby('month').sum()['load']\nmonthly['cycles']=hourly.groupby('month').sum()['movement']/2\nmonthly['buy']=hourly.groupby('month').sum()['buy']\nmonthly['buy_cost']=hourly.groupby('month').sum()['buy_cost']\nmonthly['avg_buy_cost']=monthly['buy_cost']/monthly['buy']\n\n\nmonthly.to_csv('maxgen.csv')\nhourly.to_csv('out_data.csv')\nmonth_period.to_csv('month_cost.csv')\n\n\n\nmonth_file_path=\"s_run/{sr}/pcm-monthly-{rid}.csv\".format(sr=scenario_run,rid=run_id)\nhour_file_path=\"s_run/{sr}/pcm-hourly-{rid}.csv\".format(sr=scenario_run,rid=run_id)\nmonth_period_file_path=\"s_run/{sr}/pcm-monthperiod-{rid}.csv\".format(sr=scenario_run,rid=run_id)\n\nmonthly.to_csv(month_file_path)\nhourly.to_csv(hour_file_path)\nmonth_period.to_csv(month_period_file_path)\n\nmonth_file=FileOutput(\n\t\tname=\"PCM monthly [{rid}].csv\".format(rid=run_id),\n\t\titem_id=\"pcm-monthly-{rid}-csv\".format(rid=run_id),\n\t\tfile_path=month_file_path,\n\t\ttid=output_team\n\t)\nhour_file=FileOutput(\n\t\tname=\"PCM hourly [{rid}].csv\".format(rid=run_id),\n\t\titem_id=\"pcm-hourly-{rid}-csv\".format(rid=run_id),\n\t\tfile_path=hour_file_path,\n\t\ttid=output_team\n\t)\nmonthperiod_file=FileOutput(\n\t\tname=\"PCM month-period [{rid}].csv\".format(rid=run_id),\n\t\titem_id=\"pcm-monthperiod-{rid}-csv\".format(rid=run_id),\n\t\tfile_path=month_period_file_path,\n\t\ttid=output_team\n\t)\n\t\nmonth_file.set_meta_data()\nhour_file.set_meta_data()\nmonthperiod_file.set_meta_data()\n\nhour_data_item={\n    \"body\":{\n        \"file\": \"team/{tid}/file/{fid}\".format(tid=output_team,fid='ao_'+hour_file.item_id)\n    },\n    \"columns\": [\n        {\n          \"name\": \"Time Index\",\n          \"prop\": \"\",\n          \"visible\": \"legendonly\"\n        },\n        {\n          \"name\": \"State of Charge\",\n          \"prop\": \"state_of_charge\"\n        },\n        {\n          \"name\": \"Battery Dispatch\",\n          \"prop\": \"dispatch\"\n        },\n        {\n          \"name\": \"Solar Gen\",\n          \"prop\": \"solar\"\n        },\n        {\n          \"name\": \"Load\",\n          \"prop\": \"load\"\n        },\n        {\n          \"name\": \"Buy\",\n          \"prop\": \"buy\"\n        },\n        {\n          \"name\": \"Buy Cost\",\n          \"prop\": \"buy_cost\",\n          \"visible\": \"legendonly\"\n        },\n        {\n          \"name\": \"Demand Period\",\n          \"prop\": \"demand_period\"\n        },\n        {\n          \"name\": \"Energy Rate\",\n          \"prop\": \"energy_rate\"\n        },\n        {\n          \"name\": \"Date\",\n          \"prop\": \"date\",\n          \"timeIndex\": True,\n          \"visible\": \"legendonly\"\n        },\n        {\n          \"name\": \"Month\",\n          \"prop\": \"month\",\n          \"visible\": \"legendonly\"\n        },\n        {\n          \"name\": \"Hour\",\n          \"prop\": \"hour\",\n          \"visible\": \"legendonly\"\n        },\n        {\n          \"name\": \"Weekday\",\n          \"prop\": \"weekday\"\n        },\n        {\n          \"name\": \"Movement\",\n          \"prop\": \"movement\"\n        },\n        {\n          \"name\": \"Cycles\",\n          \"prop\": \"cycles\",\n          \"visible\": \"legendonly\"\n        }\n   ],\n  \"parameter\": {\n    \"name\": {\n      \"name\": \"Hourly [{rid}]\".format(rid=run_id),\n    }\n  },\n  \"tags\": [\n    \"timeseries\",\n    \"data\"\n  ],\n  \"type\": \"data:timeseries\"\n}\n\nmonth_data_item={\n  \"body\": {\n        \"file\": \"team/{tid}/file/{fid}\".format(tid=output_team,fid='ao_'+month_file.item_id)\n  },\n  \"columns\": [\n    {\n      \"name\": \"month\",\n      \"prop\": \"month\",\n      \"timeIndex\": True\n    },\n    {\n      \"name\": \"Energy Cost\",\n      \"prop\": \"energy\"\n    },\n    {\n      \"name\": \"Demand Charge\",\n      \"prop\": \"demand\"\n    },\n    {\n      \"name\": \"Total Cost\",\n      \"prop\": \"total\"\n    },\n    {\n      \"name\": \"Solar Gen\",\n      \"prop\": \"solar\"\n    },\n    {\n      \"name\": \"Load\",\n      \"prop\": \"load\"\n    },\n    {\n      \"name\": \"Buy\",\n      \"prop\": \"buy\"\n    },\n    {\n      \"name\": \"Mean Energy Cost\",\n      \"prop\": \"avg_buy_cost\"\n    },\n    {\n      \"name\": \"Cycles\",\n      \"prop\": \"cycles\"\n    },\n  ],\n  \"parameter\": {\n    \"name\": {\n      \"name\": \"Monthly [{rid}]\".format(rid=run_id),\n      \"type\": \"parameter:name:basic\"\n    }\n  },\n  \"tags\": [\n    \"timeseries\",\n    \"data\"\n  ],\n  \"type\": \"data:timeseries\"\n}\n\nannual=monthly.sum()\nprint annual\n\ntask_output=Output()\ntask_output.set_data({\n\t\"annual_electricity_cost\":annual['total'],\n\t\"annual_demand_charge\":annual['demand'],\n\t\"annual_energy_charge\":annual['energy'],\n\t\"annual_cycles\":hourly['movement'].sum()/2,\n\t\"battery_power\":p_nom,\n\t\"battery_duration\": duration,\n\t\"battery_energy\": p_nom*duration\n})\ntask_output.add_file(month_file.get_file_ref())\ntask_output.add_file(hour_file.get_file_ref())\ntask_output.add_file(monthperiod_file.get_file_ref())\ntask_output.add_data_item({\n    \"item\":hour_data_item,\n    \"tid\":output_team\n    })\ntask_output.add_data_item({\n    \"item\":month_data_item,\n    \"tid\":output_team\n    })\nobj=task_output.get_output_obj()\nprint obj\n\n",
            "name": "task-run-pypsa.py",
            "type": "parameter:file:python"
          },
          "name": {
            "aoSets": [
              "parameter:name:basic"
            ],
            "description": "test",
            "name": "AO PyPSA v1",
            "type": "parameter:name:basic"
          },
          "runtime": {
            "aoSets": [
              "parameter:runtime:basic"
            ],
            "args": "task-run-pypsa.py $scenarioRun",
            "entry": "python",
            "image": "133579274133.dkr.ecr.us-west-2.amazonaws.com/andersonopt/task-pypsa",
            "type": "parameter:runtime:basic"
          },
          "taskselector": {
            "aoSets": [
              "parameter:taskselector:basic"
            ],
            "queue": "task-dev",
            "type": "parameter:taskselector:basic",
            "typefilter": "scenario:power:pypsa"
          },
          "workspace": {
            "aoSets": [
              "parameter:workspace:basic"
            ],
            "type": "parameter:workspace:basic",
            "workspace": "kickass_blackwell"
          }
        },
        "queue": "dev:task-compute",
        "rn": "team/rmi-freeport/task/-L_pSH_edSKeHvXUJZZ8",
        "tags": [
          "docker",
          "task"
        ],
        "type": "task:docker",
        "version": 1
      },
      "itemKey": "scenario",
      "rn": "team/rmi-freeport/task/-L_pSH_edSKeHvXUJZZ8",
      "stepKey": "power"
    },
    {
      "item": {
        "created": 1552453806172,
        "createdBy": "google-oauth2|104792385606727687265",
        "id": "-L_pSHVyM4QMx5Q_F4E3",
        "modified": 1561565636487,
        "modifiedBy": "google-oauth2|104792385606727687265",
        "parameter": {
          "event": {
            "aoSets": [
              "parameter:event:basic"
            ],
            "data": {
              "key": "test"
            },
            "type": "parameter:event:basic"
          },
          "file": {
            "aoSets": [
              "parameter:file:python"
            ],
            "data": "\nfrom sam import Sam, get_path, get_file_item\nimport pprint\nimport sys\nimport json\nimport pandas as pd\nimport datetime\nfrom datetime import timedelta\npp = pprint.PrettyPrinter(indent=4)\n\n## Load Context\nscenario_run=sys.argv[1]\nprint \"scenario run\",scenario_run\n\n\nscenario_run_item=json.loads(sys.argv[2])\nrun_id=scenario_run_item['name']['runId']\nprint \"scenario run item\",run_id,scenario_run_item\n\ntilt=None\ntrackmode=None\ntilt_eq_lat=None\n\nif scenario_run:\n\tscenario_folder='/'.join(['s_run',scenario_run])\n\tcontext_file='/'.join([scenario_folder,'context.json'])\n\twith open(context_file) as infile:\n\t\tdata = json.load(infile)\n\t\tprimaries=[itemRef['item'] for itemRef in data['asset'] if itemRef['groupKey']=='primary']\n\t\tprimary=primaries[0]\n\t\tlat=primary['parameter']['location']['lat']\n\t\tlng=primary['parameter']['location']['long']\n\t\twkt=get_path(scenario_run_item,'step.weather.output.weather_tag')\n\t\t#desired_capacity=data['overrides'][0]['value']*1000\n\t\tdesired_capacity=float(get_path(data,'project.step.solar.parameter.solar.capacityPower'))*1000\n\t\tdctoacratio=get_path(data,'scenario.step.sam.parameter.systemdesign.dctoacratio')\n\t\ttilt=get_path(data,'scenario.step.sam.parameter.panelorientation.tilt')\n\t\ttrackmode=get_path(data,'scenario.step.sam.parameter.panelorientation.tracker')\n\t\ttilt_eq_lat=get_path(data,'scenario.step.sam.parameter.panelorientation.tilt_eq_lat')\nelse:\n\tscenario_run='test'\n\tscenario_folder='/'.join(['s_run',scenario_run])\n\tdesired_capacity=10000\n\tlat=41.8\n\tlng=-97.4\n\twkt=\"POINT({lng}%20{lat})\".format(lat=lat, lng=lng)\n\tdctoacratio=1.2\n\nprint \"Register SAM\"\ns = Sam()\n\n\nparam = {\n\t\"weather_file\": 'weather/data/{wkt}.csv'.format(wkt=wkt),\n\t\"system\":{\n\t\t\"modules_per_string\": 6,\n\t\t\"strings_in_parallel\": 497,\n\t\t\"inverter_count\": 219\n\t},\n\t\"orientation\":{\n\t\t\"tilt\": 41,\n\t\t\"tilt_eq_lat\": 0,\n\t\t\"azimuth\": 180,\n\t\t\"ground_coverage_ratio\": 0.3,\n\t\t\"rotation_limit\": 45\n\t}\n}\t\n\nif tilt:\n    param['orientation']['tilt']=tilt\n\nif trackmode == '1 Axis':\n\tparam['orientation']['track_mode']=1\n\nif tilt_eq_lat:\n\tparam['orientation']['tilt_eq_lat']=1\n\n## Fixed panel and inverter settings\npanel_kw=335.205/1000\ninverter_ac_cap_kw=3800/1000\ninverter_dc_cap_kw=3928/1000\n\n## Adjust system for desired capacity\nkwh_per_string=panel_kw*param['system']['modules_per_string']\nstrings = desired_capacity/kwh_per_string\nparam[\"system\"][\"strings_in_parallel\"]=int(round(strings))\nprint \"Strings\",strings,round(strings)\n\n## Calcs for system design\nnumber_of_modules=param['system']['modules_per_string']*param['system']['strings_in_parallel']\n\nsystem_nameplate_capacity=number_of_modules*panel_kw\n\ninverters=system_nameplate_capacity/dctoacratio/inverter_ac_cap_kw\nparam['system']['inverter_count']=int(round(inverters))\n\nprint \"Inverters\",inverters,round(inverters)\n\n\n\nsystem_ac_capacity=param['system']['inverter_count']*inverter_ac_cap_kw\nsystem_dc_capacity=param['system']['inverter_count']*inverter_dc_cap_kw\n\nif system_ac_capacity:\n    dc_to_ac_ratio=system_nameplate_capacity/system_ac_capacity\nelse:\n    dc_to_ac_ratio=0\n\nparam[\"system\"][\"system_capacity\"]=system_nameplate_capacity\n\nprint \"\"\nprint \"SystemDesign\"\nprint \"Number of Modules:\",number_of_modules\nprint \"Nameplate Capacity:\",system_nameplate_capacity\nprint \"Inverters AC Capacity:\",system_ac_capacity\nprint \"DC to AC Ratio:\",dc_to_ac_ratio\n\n\nprint \"\"\nprint \"Params\"\n#pp.pprint(param)\n\nout_data=s.run(param)\nout_data['solar_capacity']=desired_capacity/1000\n#print s.output\ngen=get_path(s.output,'pvsamv1.output.time series.gen')\n#print gen\n\ndf = pd.DataFrame(gen,columns=['gen'])\nstart=datetime.datetime(2020,1,1)\ndef create_datetime(x):\n\treturn str(start + timedelta(hours=x.name))\ndf['datetime'] = df.apply(create_datetime,axis=1)\ndf = df[['datetime','gen']]\nprint start\nprint df.head()\n\n#s.dump('test.json')\nprint \"\"\nprint \"Output\"\n#pp.pprint(out_data)\nprint \"Run complete\"\n\nfile_data={\n\t'annual': get_path(s.output,'pvsamv1.output.annual'),\n\t'annual_year_1': get_path(s.output,'pvsamv1.output.annual (year 1)'),\n\t'loss': get_path(s.output,'pvsamv1.output.loss'),\n\t'monthly': get_path(s.output,'pvsamv1.output.monthly'),\n\t'misc': get_path(s.output,'pvsamv1.output.miscellaneous')\n}\n\nname=\"NREL Sam Output [{rid}]\".format(rid=run_id)\nitemid=\"nrel-sam-output-{rid}-json\".format(rid=run_id)\ndata_file=scenario_folder + '/nrel-sam-output-{rid}.json'.format(rid=run_id)\nfilename='nrel-sam-output-{rid}.json'.format(rid=run_id)\n\nwith open(data_file,'w') as outfiledata:\n\tjson.dump(file_data,outfiledata,indent=4)\n\nao_item = get_file_item(data_file,itemid,name,filename)\nprint \"AO Item to create\",ao_item\n\n\nfile_output={\n\t\"path\":data_file,\n\t\"item\":ao_item,\n\t\"tid\":\"rmi-test-beta-system\",\n\t\"overwrite\":False\t\n}\n\ndataitemname=\"NREL Sam Gen [{rid}]\".format(rid=run_id)\ndataitemid=\"nrel-sam-gen-{rid}-json\".format(rid=run_id)\ndata_upload_file=scenario_folder+'/nrel-sam-gen-{rid}.json'.format(rid=run_id)\n\ndata_out=df.to_dict('records')\nwith open(data_upload_file,'w') as outfile:\n\tjson.dump(data_out,outfile)\n\ndata_item={\n\t\"id\":dataitemid,\n\t\"type\": \"data:timeseries:8760\",\n\t\"tags\":[\n\t\t\"data\",\n\t\t\"timeseries\",\n\t\t8760\n\t],\n\t\"parameter\":{\n\t\t\"name\": {\n\t\t\t\"name\": dataitemname\n\t\t}\n\t},\n\t\"columns\":[\n\t\t{\n\t\t\"format\": \"DateTime\",\n\t\t\"name\": \"DateTime\",\n\t\t\"prop\": \"datetime\"\n\t\t},{\n\t\t\"format\": \"Float\",\n\t\t\"name\": \"Gen\",\n\t\t\"prop\": \"gen\"\n\t\t}\n\t],\n\t\"body\":{\n\t    \"stringify\":True\n\t}\n}\n\ndata_output={\n\t\"body\": data_upload_file,\n\t\"item\":data_item,\n\t\"tid\":\"rmi-test-beta-system\",\n\t\"overwrite\": True\n}\n\nloss_dataitemname=\"NREL Sam Loss [{rid}]\".format(rid=run_id)\nloss_dataitemid=\"nrel-sam-loss-{rid}-json\".format(rid=run_id)\nloss_data_upload_file=scenario_folder+'/nrel-sam-loss-{rid}.json'.format(rid=run_id)\n\nloss_path='pvsamv1.output.loss'\nloss_map=[\n    [\"annual_poa_shading_loss_percent\", \"POA shading loss\"], \n    [\"annual_poa_soiling_loss_percent\", \"POA soiling loss\"], \n    [\"annual_dc_module_loss_percent\", \"DC module modeled\"], \n    [\"annual_dc_diodes_loss_percent\", \"DC diodes and connections\"], \n    [\"annual_dc_wiring_loss_percent\", \"DC wiring\"], \n    [\"annual_dc_optimizer_loss_percent\", \"DC power optimizer\"], \n    [\"annual_dc_perf_adj_loss_percent\", \"DC performance adjustment\"], \n    [\"annual_dc_nameplate_loss_percent\", \"DC nameplate\"], \n    [\"annual_dc_tracking_loss_percent\", \"DC tracking\"], \n    [\"annual_dc_mismatch_loss_percent\", \"DC mismatch\"], \n    [\"annual_dc_mppt_clip_loss_percent\", \"DC inverter MPPT clipping\"], \n    [\"annual_ac_inv_pnt_loss_percent\", \"AC inverter pnt\"], \n    [\"annual_ac_inv_pso_loss_percent\", \"AC inverfter pso\"], \n    [\"annual_ac_inv_clip_loss_percent\", \"AC inverter power clipping\"], \n    [\"annual_ac_inv_eff_loss_percent\", \"AC inverter efficiency\"], \n    [\"annual_ac_wiring_loss_percent\", \"AC wiring\"], \n    [\"annual_ac_perf_adj_loss_percent\", \"AC performance adjustment\"], \n    [\"annual_xfmr_loss_percent\", \"Transformer\"]\n]\n\n#\"annual_ac_battery_loss_percent\": \"\", \n#\"annual_dc_lifetime_loss_percent\": \"\", \n#\"annual_dc_battery_loss_percent\": \"\", \n#\"annual_dc_snow_loss_percent\": \"\", \n#\"annual_ac_lifetime_loss_percent\": \"\", \n\nloss_data_out=[]\nfor key,name in loss_map:\n    value=get_path(s.output,loss_path+'.'+key)\n    loss_data_out.append({\n        \"key\":key,\n        \"name\":name,\n        \"value\":value\n    })\n\nprint loss_data_out    \n\nwith open(loss_data_upload_file,'w') as outfile:\n\tjson.dump(loss_data_out,outfile)\n\nloss_data_item={\n\t\"id\":loss_dataitemid,\n\t\"type\": \"data:keyvalue\",\n\t\"tags\":[\n\t\t\"data\",\n\t\t\"keyvalue\"\n\t],\n\t\"parameter\":{\n\t\t\"name\": {\n\t\t\t\"name\": loss_dataitemname\n\t\t}\n\t},\n\t\"columns\":[\n\t\t{\n\t\t\"format\": \"String\",\n\t\t\"name\": \"Key\",\n\t\t\"prop\": \"key\"\n\t\t},{\n\t\t\"format\": \"String\",\n\t\t\"name\": \"Name\",\n\t\t\"prop\": \"name\"\n\t\t},{\n\t\t\"format\": \"Float\",\n\t\t\"name\": \"Value\",\n\t\t\"prop\": \"value\"\n\t\t}\n\t]\n}\n\nloss_data_output={\n\t\"body\": loss_data_upload_file,\n\t\"item\":loss_data_item,\n\t\"tid\":\"rmi-test-beta-system\",\n\t\"overwrite\": True\n}\n\noutput = {\n\t\"data\": out_data,\n\t\"dataitem\":[\n\t\tdata_output,\n\t\tloss_data_output\n\t],\n\t\"file\":[\n\t\tfile_output\n\t],\n\t\"output\": \"Test\"\n}\nstring = json.dumps(output)\nprint \"\"\nprint \"\"\nprint \"\"\nsys.stdout.flush()\nprint string\nsys.stdout.flush()",
            "name": "task-nrel-sam.py",
            "type": "parameter:file:python"
          },
          "name": {
            "aoSets": [
              "parameter:name:basic"
            ],
            "description": "test",
            "name": "NREL Sam Analysis v1",
            "type": "parameter:name:basic"
          },
          "runtime": {
            "aoSets": [
              "parameter:runtime:basic"
            ],
            "args": "task-nrel-sam.py $scenarioRun",
            "entry": "python",
            "image": "andersonopt/ao-nrel-sam:latest",
            "type": "parameter:runtime:basic"
          },
          "taskselector": {
            "aoSets": [
              "parameter:taskselector:basic"
            ],
            "queue": "task-dev",
            "type": "parameter:taskselector:basic",
            "typefilter": "scenario:nrel:sam"
          },
          "workspace": {
            "aoSets": [
              "parameter:workspace:basic"
            ],
            "type": "parameter:workspace:basic",
            "workspace": "kickass_blackwell"
          }
        },
        "queue": "dev:task-general",
        "rn": "team/rmi-freeport/task/-L_pSHVyM4QMx5Q_F4E3",
        "tags": [
          "docker",
          "task"
        ],
        "type": "task:docker",
        "version": 1
      },
      "itemKey": "scenario",
      "rn": "team/rmi-freeport/task/-L_pSHVyM4QMx5Q_F4E3",
      "stepKey": "sam"
    },
    {
      "item": {
        "created": 1552453806022,
        "createdBy": "google-oauth2|104792385606727687265",
        "id": "-L_pSHTYIis-8UV8Hpbb",
        "modified": 1561565642795,
        "modifiedBy": "google-oauth2|104792385606727687265",
        "parameter": {
          "event": {
            "aoSets": [
              "parameter:event:basic"
            ],
            "data": {
              "key": "test"
            },
            "type": "parameter:event:basic"
          },
          "file": {
            "aoSets": [
              "parameter:file:python"
            ],
            "data": "import sys, os\nimport os.path\nimport time\nfrom sam.weather import get_url,grab_data\nfrom sam import get_file_item\nimport pandas as pd\nimport csv\nimport json\n\n\nprint(\"FetchWeather\")\nprint(\"Arguments %s\",sys.argv[:-2])\nscenario_run=sys.argv[1]\nprint \"scenario run\",scenario_run\n\nweather_year=None\ninterval=None\n\nif scenario_run:\n    scenario_folder='/'.join(['s_run',scenario_run])\n    context_file='/'.join([scenario_folder,'context.json'])\n    with open(context_file) as infile:\n    \tdata = json.load(infile)\n    \tprimaries=[itemRef['item'] for itemRef in data['asset'] if itemRef['groupKey']=='primary']\n    \tprimary=primaries[0]\n    \tlat=primary['parameter']['location']['lat']\n    \tlng=primary['parameter']['location']['long']\n    \tprint \"Data\",data.keys()\n    \tprint \"Scenario\",data['scenario']\n    \tweather_year=data['scenario']['step']['weather']['parameter']['nsrdbweather']['weatheryear']\n    \tinterval=data['scenario']['step']['weather']['parameter']['nsrdbweather']['interval']\nelse:\n    lat=41.91\n    lng=-97.4\n\nrequest_dir='weather/request'\ndata_dir='weather/data'\n\n\n#wkt,url = get_url(41.8,-97.4)\nwkt,url = get_url(lat,lng)\n\n\nprint \"latlng\",lat,lng\nprint \"Location:\",wkt\n\nif weather_year:\n    url=url.replace('names=tmy','names={yr}'.format(yr=weather_year))\n    wkt+='_y{yr}'.format(yr=weather_year)\nif interval:\n    url=url.replace('interval=60','interval={interval}'.format(interval=interval))\n    wkt+='_i{i}'.format(i=interval)\n\nprint \"Weather URL: \",url\n\ndef user_format(num):\n    return str(round(float(num),3))\n    \nwkt_no_dot=wkt.replace('.','_').replace('%20','__')\nwkt_user='({lat},{lng})'.format(lat=user_format(lat),lng=user_format(lng))\n\nrequest_file=request_dir+'/{wkt}.csv'.format(wkt=wkt)\ndata_file=data_dir+'/{wkt}.csv'.format(wkt=wkt)\ndata_upload_file=data_dir+'/{wkt}.json'.format(wkt=wkt)\n\nfilename=\"nsrdb-weather-{wkt}.csv\".format(wkt=wkt_no_dot)\ndataitemname=\"NSRDB Weather {wkt} Data\".format(wkt=wkt_user)\ndataitemid=\"nsrdb-weather-{wkt}-json\".format(wkt=wkt_no_dot)\nitemid=\"nsrdb-weather-{wkt}-csv\".format(wkt=wkt_no_dot)\nname=\"NSRDB Weather {wkt}\".format(wkt=wkt_user)\n\ndef ensure_data_upload(data_file,data_upload_file):\n\tif os.path.isfile(data_upload_file):\n\t\twith open(data_upload_file,'r') as infile:\n\t\t\tdata = json.load(infile)\n\t\t\tdf = pd.DataFrame(data)\n\t\t\treturn df\n\n\tdf = pd.read_csv(data_file,skiprows=2)\n\tdf['datetime']=pd.to_datetime(df[['Year','Month','Day','Hour','Minute']])\n\tdf['datetime']=df['datetime'].apply(lambda dt: str(dt.replace(year=2020)))\n\tdf_data=df[['datetime','GHI','Temperature','Wind Speed']]\n\tdf_data.columns = df_data.columns.str.replace(' ','')\n\tdata_out=df_data.dropna().to_dict('records')\n\twith open(data_upload_file,'w') as outfile:\n\t\tjson.dump(data_out,outfile)\n\treturn df_data\n\n\ndef finished():\n\tprint \"Finished\"\n\tprint \"\"\n\tprint \"metadata\"\n\twith open(data_file, 'r+') as afile:\n\t\tcsvReader1 = csv.reader(afile)\n\t\tfor i in range(2):\n\t\t\tprint csvReader1.next()\n\tdf = pd.read_csv(data_file,skiprows=2)\n\n\tprint \"\"\n\tprint \"data\"\n\tprint \"shape\",df.shape\n\tprint \"columns\",df.columns.values\n\tprint df.head()\n\tout={}\n\tout['annual_dni']=df['DNI'].sum()\n\tout['annual_dhi']=df['DHI'].sum()\n\tout['annual_ghi']=df['GHI'].sum()\n\tout['avg_temp']=df['Temperature'].mean()\n\tout['avg_windspeed']=df['Wind Speed'].mean()\n\tout['weather_tag']=wkt\n\t\n\n\tprint \"\"\n\tprint \"Ensure data upload\"\n\tdf_data=ensure_data_upload(data_file,data_upload_file)\n\tprint df_data.head()\n\n\tdata_item={\n\t\t\"id\":dataitemid,\n\t\t\"type\": \"data:timeseries:8760\",\n\t\t\"tags\":[\n\t\t\t\"data\",\n\t\t\t\"timeseries\",\n\t\t\t8760\n\t\t],\n\t\t\"parameter\":{\n\t\t\t\"name\": {\n\t\t\t\t\"name\": dataitemname\n\t\t\t}\n\t\t},\n\t\t\"columns\":[\n\t\t\t{\n\t\t\t\"format\": \"DateTime\",\n\t\t\t\"name\": \"DateTime\",\n\t\t\t\"prop\": \"datetime\"\n\t\t\t},{\n\t\t\t\"format\": \"Float\",\n\t\t\t\"name\": \"GHI\",\n\t\t\t\"prop\": \"GHI\"\n\t\t\t},{\n\t\t\t\"format\": \"Float\",\n\t\t\t\"name\": \"Temperature\",\n\t\t\t\"prop\": \"Temperature\"\n\t\t\t},{\n\t\t\t\"format\": \"Float\",\n\t\t\t\"name\": \"Wind Speed\",\n\t\t\t\"prop\": \"WindSpeed\"\n\t\t\t}\n\t\t]\n\t}\n\n\tdata_output={\n\t\t\"body\": data_upload_file,\n\t\t\"item\":data_item,\n\t    \"tid\":\"rmi-test-beta-system\",\n\t\t\"overwrite\": False\n\t}\n\n\tao_item = get_file_item(data_file,itemid,name,filename)\n\tprint \"AO Item to create\",ao_item\n\t\n\t\n\tfile_output={\n\t\t\"path\":data_file,\n\t\t\"item\":ao_item,\n\t    \"tid\":\"rmi-test-beta-system\",\n\t\t\"overwrite\":False\t\n\t}\n\toutput = {\n\t\t\"data\": out,\n\t\t\"output\": \"Test\",\n\t\t\"file\":[\n\t\t\tfile_output\n\t\t],\n\t\t\"dataitem\":[\n\t\t\tdata_output\n\t\t]\n\t}\n\tstring = json.dumps(output)\n\tprint string\n\tsys.exit()\n\n\t\n## Check for existing file\n\nif os.path.isfile(data_file):\n\tprint \"Data file exists\" \n\tfinished()\n\n## Check for outstanding request\n\nelif os.path.isfile(request_file):\n\tprint \"Request exists, poll for file\"\n\tfor i in [1,2,3,4,5,6,7,8,9,10,12,14,16,18,20,25,30,35,40,45,50,55,60]:\n\t\tprint \"Wait: \"+str(i)\n\t\tif os.path.isfile(data_file):\n\t\t\tprint \"Data file exists\"\n\t\t\tfinished()\n\t\telse:\n\t\t\ttime.sleep(i)\n\t## Attempt to grab data if poll fails\n\tgrab_data(request_file,data_file,url)\n\tensure_data_upload(data_file,data_upload_file)\n\tfinished()\n\n## Else grab data\n\nelse:\n\tprint \"File does not exist and has not been requested\"\n\tprint \"Request file:\",data_file\n\tif not os.path.exists(request_dir):\n\t    os.makedirs(request_dir)\n\tif not os.path.exists(data_dir):\n\t    os.makedirs(data_dir)\n\tgrab_data(request_file,data_file,url)\n\tensure_data_upload(data_file,data_upload_file)\n\tfinished()",
            "name": "task-fetch-weather.py",
            "type": "parameter:file:python"
          },
          "name": {
            "aoSets": [
              "parameter:name:basic"
            ],
            "description": "Grab weather data and store in workspace",
            "name": "NSRDB - Grab Weather v1",
            "type": "parameter:name:basic"
          },
          "notes": {
            "aoSets": [
              "parameter:notes:asset"
            ],
            "data": " ",
            "type": "parameter:notes:asset"
          },
          "runtime": {
            "aoSets": [
              "parameter:runtime:basic"
            ],
            "args": "task-fetch-weather.py $scenarioRun",
            "entry": "python",
            "image": "andersonopt/ao-nrel-sam",
            "type": "parameter:runtime:basic"
          },
          "taskselector": {
            "aoSets": [
              "parameter:taskselector:basic"
            ],
            "queue": "task",
            "type": "parameter:taskselector:basic",
            "typefilter": "scenario:nrel:weather"
          },
          "workspace": {
            "aoSets": [
              "parameter:workspace:basic"
            ],
            "type": "parameter:workspace:basic",
            "workspace": "kickass_blackwell"
          }
        },
        "queue": "dev:task-general",
        "rn": "team/rmi-freeport/task/-L_pSHTYIis-8UV8Hpbb",
        "tags": [
          "docker",
          "task"
        ],
        "type": "task:docker",
        "version": 1
      },
      "itemKey": "scenario",
      "rn": "team/rmi-freeport/task/-L_pSHTYIis-8UV8Hpbb",
      "stepKey": "weather"
    }
  ]
}